# 流程节点行为校验规则（Node Behavior Validation Rules）

本文档用于说明流程建模器中各类节点的**连接能力、拓扑约束及流程合法性规则**。  
所有规则均由 `NodeBehavior` 定义，并通过 `BehaviorsEngine` 执行校验。

---

## 一、校验阶段说明

### 1. 创建连线阶段（Edge Create Validation）

- 触发时机：`edge:add`
- 目的：阻止**绝对非法**的连线产生
- 特点：
    - ❌ 不校验业务完整性（如条件是否填写）
    - ❌ 不阻止“尚未配置完成”的流程
    - ✅ 只校验拓扑与类型合法性

---

### 2. 全流程校验阶段（Graph Validation）

- 触发时机：
    - 发布流程
    - 保存流程（可选）
- 目的：保证流程**可执行**
- 特点：
    - ✅ 校验条件完整性
    - ✅ 校验默认连线
    - ✅ 校验最小 / 最大连线数量

---

## 二、通用节点行为规则

| 规则项 | 说明 |
|------|------|
| `allowIn` | 是否允许作为入线节点 |
| `allowOut` | 是否允许作为出线节点 |
| `minIn` | 最小入线数量 |
| `maxIn` | 最大入线数量 |
| `minOut` | 最小出线数量 |
| `maxOut` | 最大出线数量 |
| `allowSourceTypes` | 允许的来源节点类型 |
| `allowTargetTypes` | 允许的目标节点类型 |

---

## 三、事件节点规则

### 1. 开始事件（Start Event）

| 项 | 规则 |
|--|--|
| 入线 | ❌ 不允许 |
| 出线 | ✅ 允许 |
| 出线数量 | 1 |
| 来源类型 | 无 |

**校验规则：**
- 不允许任何入线
- 必须且只能有一条出线

---

### 2. 结束事件（End Event）

| 项 | 规则 |
|--|--|
| 入线 | ✅ 允许 |
| 出线 | ❌ 不允许 |
| 入线数量 | ≥ 1 |

**校验规则：**
- 不允许有出线
- 至少存在一条入线

---

## 四、任务节点规则（Tasks）

### 通用规则（适用于所有任务）

| 项 | 规则 |
|--|--|
| 入线 | ≥ 1 |
| 出线 | ≥ 1 |
| 多入多出 | ❌ 不允许 |

---

### 1. 用户任务（User Task）

- 表示人工处理节点

**校验规则：**
- 必须有入线
- 必须有出线
- 只能有一条出线

---

### 2. 服务任务（Service Task）

- 表示系统自动执行任务

**校验规则：**
- 必须有入线
- 必须有出线
- 出线数量为 1

---

### 3. 脚本任务（Script Task）

- 表示脚本执行节点

**校验规则：**
- 必须有入线
- 必须有出线
- 出线数量为 1

---

### 4. 接收任务（Receive Task）

- 表示等待外部事件

**校验规则：**
- 必须有入线
- 出线数量 ≤ 1
- 允许无出线（流程可暂停）

---

## 五、网关节点规则（Gateways）

### 通用规则

| 项 | 规则 |
|--|--|
| 入线 | ≥ 1 |
| 出线 | ≥ 1 |
| 同节点多条连线 | ❌ 不允许 |

---

### 1. 排他网关（Exclusive Gateway）

- 表示条件互斥分支

**出线规则：**
- 至少 2 条出线
- 每条非默认出线必须配置条件
- 必须且只能存在一条默认出线

---

### 2. 包容网关（Inclusive Gateway）

- 表示条件可并行分支

**出线规则：**
- 至少 2 条出线
- 所有出线必须配置条件
- ❌ 不允许默认连线

---

### 3. 并行网关（Parallel Gateway）

- 表示并行执行

**出线规则：**
- 至少 2 条出线
- ❌ 不允许配置条件
- ❌ 不允许默认连线

---

## 六、边（Edge）行为规则

### 创建阶段（edge:add）

| 规则 | 说明 |
|--|--|
| 禁止重复连线 | 同一 source → target 仅允许一条 |
| 类型匹配 | source / target 类型必须符合节点定义 |

---

### 全流程阶段（validateGraph）

| 规则 | 说明 |
|--|--|
| 条件完整性 | 排他 / 包容网关的条件校验 |
| 默认连线 | 排他网关默认线校验 |
| 并行约束 | 并行网关不允许条件 |

---

## 七、错误级别建议（扩展）

| 级别 | 含义 |
|--|--|
| ERROR | 阻止发布 |
| WARN | 允许发布，但提示 |

---

## 八、设计原则总结

- **连线创建 ≠ 流程完成**
- **创建阶段只做结构合法性校验**
- **发布阶段才做完整性校验**
- 所有行为规则集中在 `NodeBehavior`
- 所有执行逻辑集中在 `BehaviorsEngine`

---

> 本规则文档与代码行为保持 1:1 对应，  
> 任何新增节点类型，必须同时补充对应行为规则。
